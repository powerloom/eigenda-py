# This workflow will install Python dependencies, run tests and lint with a variety of Python versions
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: Python package

on:
  push:
    branches: [ "master", "main", "develop" ]
  pull_request:
    branches: [ "master", "main", "develop" ]

jobs:
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install UV
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"
        cache-suffix: "lint"

    - name: Set up Python
      run: uv python install 3.12

    - name: Install dependencies
      run: uv sync --all-extras --frozen

    - name: Check with black
      run: |
        echo "üîç Checking code formatting with black..."
        uv run black --check src/ tests/ examples/

    - name: Check with isort
      run: |
        echo "üîç Checking import sorting with isort..."
        uv run isort --check-only src/ tests/ examples/

    - name: Lint with flake8
      run: |
        echo "üîç Running flake8 linting..."
        # Stop the build if there are Python syntax errors or undefined names
        uv run flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Check all linting rules
        uv run flake8 . --count --statistics

  test:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13"]
        os: [ubuntu-latest]
        include:
          # Add macOS and Windows testing for latest Python
          - python-version: "3.12"
            os: macos-latest
          - python-version: "3.12"
            os: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install UV
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"
        cache-suffix: "${{ matrix.os }}-py${{ matrix.python-version }}"

    - name: Set up Python ${{ matrix.python-version }}
      run: uv python install ${{ matrix.python-version }}

    - name: Install dependencies and package
      run: |
        uv sync --all-extras --frozen

    - name: Test with pytest
      run: uv run pytest tests/ --junitxml=junit/test-results-${{ matrix.python-version }}-${{ matrix.os }}.xml --cov=src/eigenda --cov-report=xml --cov-report=html --cov-report=term-missing -v

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.python-version }}-${{ matrix.os }}
        path: junit/test-results-*.xml

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: matrix.python-version == '3.12' && matrix.os == 'ubuntu-latest'
      with:
        name: coverage-reports
        path: |
          coverage.xml
          htmlcov/

  coverage:
    name: Coverage Report
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Download coverage reports
      uses: actions/download-artifact@v4
      with:
        name: coverage-reports
        path: .

    - name: Install UV
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: Set up Python
      run: uv python install 3.12

    - name: Display coverage summary
      run: |
        echo "üìä Coverage Summary"
        echo "==================="
        if [ -f coverage.xml ]; then
          uv run python -c "
        import xml.etree.ElementTree as ET
        tree = ET.parse('coverage.xml')
        root = tree.getroot()
        coverage = float(root.attrib.get('line-rate', 0)) * 100
        print(f'Total Coverage: {coverage:.2f}%')
        if coverage >= 90:
            print('‚úÖ Excellent coverage!')
        elif coverage >= 80:
            print('üëç Good coverage')
        elif coverage >= 70:
            print('‚ö†Ô∏è  Coverage could be improved')
        else:
            print('‚ùå Coverage needs improvement')
        "
        fi

    - name: Comment PR with coverage
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('coverage.xml')) {
            const xml = fs.readFileSync('coverage.xml', 'utf8');
            const match = xml.match(/line-rate="([0-9.]+)"/);
            if (match) {
              const coverage = (parseFloat(match[1]) * 100).toFixed(2);
              const emoji = coverage >= 90 ? '‚úÖ' : coverage >= 80 ? 'üëç' : coverage >= 70 ? '‚ö†Ô∏è' : '‚ùå';

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## Coverage Report ${emoji}\n\n**Total Coverage: ${coverage}%**\n\nView detailed report in the workflow artifacts.`
              });
            }
          }

  security:
    name: Security Check
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install UV
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: Set up Python
      run: uv python install 3.12

    - name: Install dependencies
      run: uv sync --all-extras --frozen

    - name: Security check with bandit
      run: |
        uv pip install bandit
        uv run bandit -r src/ -ll -f json -o bandit-report.json || true
        if [ -f bandit-report.json ]; then
          echo "üîí Security Scan Results:"
          uv run python -c "
        import json
        with open('bandit-report.json') as f:
            data = json.load(f)
            issues = data.get('results', [])
            if not issues:
                print('‚úÖ No security issues found!')
            else:
                print(f'‚ö†Ô∏è  Found {len(issues)} potential security issues')
                for issue in issues[:5]:  # Show first 5
                    print(f\"  - {issue['issue_text']} ({issue['issue_severity']})\")
        "
        fi

    - name: Check for dependency vulnerabilities
      run: |
        uv pip install safety
        uv run safety check --json --output safety-report.json || true
        if [ -f safety-report.json ]; then
          echo "üì¶ Dependency Security Check:"
          uv run python -c "
        import json
        with open('safety-report.json') as f:
            data = json.load(f)
            if not data:
                print('‚úÖ No known vulnerabilities in dependencies!')
            else:
                print(f'‚ö†Ô∏è  Found {len(data)} dependencies with known vulnerabilities')
        "
        fi

  build:
    name: Build Distribution
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install UV
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: Set up Python
      run: uv python install 3.12

    - name: Build package
      run: |
        uv build
        echo "üì¶ Built packages:"
        ls -la dist/

    - name: Check package with twine
      run: |
        uv venv
        uv pip install twine
        uv run twine check dist/*
        echo "‚úÖ Package validation passed!"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/

  summary:
    name: CI Summary
    needs: [lint, test, security, build]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Summary
      run: |
        echo "## üìä CI Pipeline Summary"
        echo ""
        echo "### Job Results:"
        echo "- Lint: ${{ needs.lint.result }}"
        echo "- Test: ${{ needs.test.result }}"
        echo "- Security: ${{ needs.security.result }}"
        echo "- Build: ${{ needs.build.result }}"
        echo ""
        if [ "${{ needs.lint.result }}" == "success" ] && \
           [ "${{ needs.test.result }}" == "success" ] && \
           [ "${{ needs.security.result }}" == "success" ] && \
           [ "${{ needs.build.result }}" == "success" ]; then
          echo "‚úÖ **All checks passed!**"
        else
          echo "‚ùå **Some checks failed. Please review the logs above.**"
          exit 1
        fi